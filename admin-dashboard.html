<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard | CashBridge</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
:root {
  --bg: #020617;
  --card: #0f172a;
  --text: #e2e8f0;
  --text-light: #94a3b8;
  --primary: #22c55e;
  --accent: #38bdf8;
  --danger: #ef4444;
  --warning: #eab308;
  --border: rgba(34, 197, 94, 0.18);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Inter', sans-serif;
}

body {
  background: linear-gradient(to bottom, #020617, #0a0f1e);
  color: var(--text);
  min-height: 100vh;
}

header {
  background: var(--card);
  padding: 1.5rem 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
  border-bottom: 1px solid var(--border);
  flex-wrap: wrap;
  gap: 1rem;
}

header h1 {
  color: var(--primary);
  font-size: 1.8rem;
  font-weight: 700;
  font-family: 'Playfair Display', serif;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.header-btns {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.logout-btn {
  background: var(--danger);
  color: #fff;
  padding: 0.8rem 1.5rem;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  transition: 0.3s;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.logout-btn:hover {
  background: #dc2626;
  transform: translateY(-2px);
}

.reset-btn {
  background: #7c3aed;
  color: #fff;
  padding: 0.8rem 1.5rem;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  transition: 0.3s;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.reset-btn:hover {
  background: #6d28d9;
  transform: translateY(-2px);
}

.main {
  padding: 2rem;
  max-width: 1600px;
  margin: 0 auto;
}

.card {
  background: var(--card);
  padding: 2rem;
  border-radius: 20px;
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
  border: 1px solid var(--border);
  margin-bottom: 2rem;
}

.section-title {
  font-size: 1.5rem;
  margin-bottom: 1.5rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.stat-card {
  background: var(--card);
  padding: 2rem;
  border-radius: 16px;
  border: 1px solid var(--border);
  text-align: center;
  transition: 0.3s;
}

.stat-card:hover {
  transform: translateY(-5px);
  border-color: var(--primary);
}

.stat-icon {
  font-size: 2.5rem;
  margin-bottom: 1rem;
}

.stat-value {
  font-size: 2rem;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 0.5rem;
}

.stat-label {
  color: var(--text-light);
  font-size: 0.9rem;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  padding: 1rem;
  text-align: left;
  border-bottom: 1px solid var(--border);
}

th {
  background: rgba(30, 41, 59, 0.8);
  color: var(--accent);
  font-weight: 700;
  text-transform: uppercase;
  font-size: 0.85rem;
}

td {
  color: var(--text-light);
}

tr:hover {
  background: rgba(34, 197, 94, 0.05);
}

.btn {
  padding: 0.6rem 1.2rem;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: 0.3s;
  font-size: 0.85rem;
  margin: 0.2rem;
}

.btn-success {
  background: var(--primary);
  color: #000;
}

.btn-success:hover {
  background: #16a34a;
}

.btn-danger {
  background: var(--danger);
  color: #fff;
}

.btn-danger:hover {
  background: #dc2626;
}

.btn-info {
  background: var(--accent);
  color: #000;
}

.btn-info:hover {
  background: #0284c7;
}

.btn-warning {
  background: var(--warning);
  color: #000;
}

.btn-warning:hover {
  background: #f59e0b;
}

.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  color: var(--text-light);
}

.empty-state i {
  font-size: 4rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

.search-box {
  width: 100%;
  max-width: 400px;
  padding: 0.8rem 1rem;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: rgba(2, 6, 23, 0.7);
  color: var(--text);
  margin-bottom: 1rem;
}

.loading {
  text-align: center;
  padding: 3rem;
  color: var(--primary);
}

.bank-details {
  background: rgba(56, 189, 248, 0.1);
  padding: 0.8rem;
  border-radius: 8px;
  margin-top: 0.5rem;
  border-left: 3px solid var(--accent);
}

.bank-details div {
  margin: 0.3rem 0;
  font-size: 0.9rem;
}

.bank-details strong {
  color: var(--accent);
}

.btn-green {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.8rem 1.5rem;
  background-color: #28a745;
  color: white;
  font-size: 0.95rem;
  font-weight: 600;
  text-decoration: none;
  text-align: center;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-green:hover {
  background-color: #218838;
  transform: translateY(-2px);
}

.referral-level {
  display: inline-block;
  padding: 0.3rem 0.7rem;
  border-radius: 6px;
  font-size: 0.8rem;
  font-weight: 600;
  margin-left: 0.5rem;
}

.level-1 { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
.level-2 { background: rgba(56, 189, 248, 0.2); color: #38bdf8; }
.level-3 { background: rgba(234, 179, 8, 0.2); color: #eab308; }

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  .main {
    padding: 1rem;
  }
  th, td {
    padding: 0.6rem 0.4rem;
    font-size: 0.8rem;
  }
}
</style>
</head>
<body>
<header>
  <h1><i class="fas fa-shield-alt"></i> CashBridge Admin</h1>
  <div class="header-btns">
    <a href="admin-deposits.html" class="btn-green"><i class="fas fa-money-bill-wave"></i> View Deposits</a>
    <a href="admin-loan.html" class="btn-green"> <i class="fas fa-hand-holding-usd"></i> View  Loans</a>
    <a href="admin-withdrawal.html" class="btn-green"><i class="fas fa-money"</i> View Withdral</a>
     <button class="reset-btn" id="resetBtn"><i class="fas fa-redo"></i> Reset All Data</button><br>
    <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
  </div>
</header>

<div class="main">
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">üë•</div>
      <div class="stat-value" id="totalUsers">0</div>
      <div class="stat-label">Total Users</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üí∏</div>
      <div class="stat-value" id="totalWithdrawals">‚Ç¶0</div>
      <div class="stat-label">Total Withdrawals</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">‚è≥</div>
      <div class="stat-value" id="pendingCount">0</div>
      <div class="stat-label">Pending Withdrawals</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-value" id="approvedCount">0</div>
      <div class="stat-label">Approved Withdrawals</div>
    </div>
  </div>

  <div class="card">
    <h2 class="section-title"><i class="fas fa-arrow-up"></i> Pending Withdrawals</h2>
    <div id="pendingWithdrawalsTable" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
  </div>

  <div class="card">
    <h2 class="section-title"><i class="fas fa-users"></i> All Users</h2>
    <input type="text" id="userSearch" class="search-box" placeholder="Search users by name, email, or username...">
    <div id="usersTable" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import { getFirestore, doc, getDoc, getDocs, updateDoc, collection, query, where, orderBy, increment, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCubmbN-jRq33AHGL7WxxeILOrV-1_QCxo",
  authDomain: "cashbridge-a688e.firebaseapp.com",
  projectId: "cashbridge-a688e",
  storageBucket: "cashbridge-a688e.firebasestorage.app",
  messagingSenderId: "345273765518",
  appId: "1:345273765518:web:29ee0b8f9717cdb50203df"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

await setPersistence(auth, browserLocalPersistence);

const formatCurrency = (amount) => "‚Ç¶" + Number(amount || 0).toLocaleString();
let users = [];

document.getElementById('logoutBtn').onclick = async () => {
  const result = await Swal.fire({
    title: 'Logout?',
    text: 'Are you sure you want to logout?',
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'Yes, Logout',
    cancelButtonText: 'Cancel',
    confirmButtonColor: '#ef4444'
  });
  
  if (result.isConfirmed) {
    await signOut(auth);
    location.href = 'admin-login.html';
  }
};

document.getElementById('resetBtn').onclick = async () => {
  const firstConfirm = await Swal.fire({
    title: '‚ö†Ô∏è RESET ALL DATA?',
    html: `
      <div style="text-align:left;padding:1rem">
        <p style="color:#ef4444;font-weight:700;font-size:1.1rem;margin-bottom:1rem">This will PERMANENTLY delete:</p>
        <ul style="line-height:2;margin-left:1.5rem">
          <li>All users (except admins)</li>
          <li>All deposits</li>
          <li>All withdrawals</li>
          <li>All referrals</li>
          <li>All active investment plans</li>
        </ul>
        <p style="color:#ef4444;margin-top:1.5rem;font-weight:600">‚ö†Ô∏è THIS CANNOT BE UNDONE!</p>
      </div>
    `,
    icon: 'error',
    showCancelButton: true,
    confirmButtonText: 'Yes, Delete Everything',
    cancelButtonText: 'Cancel',
    confirmButtonColor: '#ef4444',
    width: 600
  });
  
  if (!firstConfirm.isConfirmed) return;
  
  const { value: confirmation } = await Swal.fire({
    title: 'FINAL CONFIRMATION',
    html: '<p style="margin-bottom:1rem">Type <b style="color:#ef4444">DELETE EVERYTHING</b> to confirm:</p>',
    input: 'text',
    inputPlaceholder: 'DELETE EVERYTHING',
    showCancelButton: true,
    confirmButtonColor: '#ef4444',
    confirmButtonText: 'Confirm Reset',
    inputValidator: (value) => {
      if (value !== 'DELETE EVERYTHING') {
        return 'You must type "DELETE EVERYTHING" exactly';
      }
    }
  });
  
  if (!confirmation) return;
  
  try {
    Swal.fire({
      title: 'Resetting Database...',
      html: '<p>Please wait, this may take a moment</p>',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });
    
    const allUsers = await getDocs(collection(db, 'users'));
    let deleteCount = 0;
    
    for (const userDoc of allUsers.docs) {
      const userData = userDoc.data();
      if (userData.role === 'admin') continue;
      
      const batch = writeBatch(db);
      batch.delete(doc(db, 'users', userDoc.id));
      
      const userDeps = await getDocs(collection(db, `users/${userDoc.id}/deposits`));
      userDeps.forEach(d => batch.delete(d.ref));
      
      const userWiths = await getDocs(collection(db, `users/${userDoc.id}/withdrawals`));
      userWiths.forEach(w => batch.delete(w.ref));
      
      const userRefs = await getDocs(collection(db, `users/${userDoc.id}/referrals`));
      userRefs.forEach(r => batch.delete(r.ref));
      
      const userPlans = await getDocs(collection(db, `users/${userDoc.id}/activePlans`));
      userPlans.forEach(p => batch.delete(p.ref));
      
      await batch.commit();
      deleteCount++;
    }
    
    await Swal.fire({
      title: '‚úÖ Reset Complete!',
      html: `<p>Successfully deleted <b>${deleteCount}</b> users and all associated data</p>`,
      icon: 'success',
      confirmButtonColor: '#22c55e'
    });
    
    loadDashboard();
  } catch (error) {
    console.error('Reset error:', error);
    Swal.fire('Error', 'Reset failed: ' + error.message, 'error');
  }
};

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    location.href = 'admin-login.html';
    return;
  }
  
  try {
    const userDoc = await getDoc(doc(db, 'users', user.uid));
    
    if (!userDoc.exists()) {
      await signOut(auth);
      location.href = 'admin-login.html';
      return;
    }
    
    const userData = userDoc.data();
    
    if (userData.role !== 'admin') {
      await Swal.fire({
        icon: 'error',
        title: 'Access Denied',
        text: 'Administrator privileges required',
        confirmButtonColor: '#ef4444'
      });
      await signOut(auth);
      location.href = 'admin-login.html';
      return;
    }
    
    loadDashboard();
  } catch (error) {
    console.error('Auth check error:', error);
    Swal.fire('Error', 'Authentication failed: ' + error.message, 'error');
    await signOut(auth);
    location.href = 'admin-login.html';
  }
});

async function loadDashboard() {
  try {
    await Promise.all([loadStats(), loadWithdrawals(), loadUsers()]);
  } catch (error) {
    console.error('Load error:', error);
    Swal.fire('Error', 'Failed to load data: ' + error.message, 'error');
  }
}

async function loadStats() {
  try {
    const usersSnapshot = await getDocs(collection(db, 'users'));
    document.getElementById('totalUsers').textContent = usersSnapshot.size;
    
    let totalWithdrawals = 0;
    let pendingWithdrawals = 0;
    let approvedWithdrawals = 0;
    
    for (const userDoc of usersSnapshot.docs) {
      const userId = userDoc.id;
      const withdrawalsSnapshot = await getDocs(collection(db, `users/${userId}/withdrawals`));
      
      withdrawalsSnapshot.forEach(withdrawalDoc => {
        const withdrawal = withdrawalDoc.data();
        if (withdrawal.status === 'approved') {
          totalWithdrawals += Number(withdrawal.amountAfterFee || withdrawal.amount || 0);
          approvedWithdrawals++;
        }
        if (withdrawal.status === 'pending') {
          pendingWithdrawals++;
        }
      });
    }
    
    document.getElementById('totalWithdrawals').textContent = formatCurrency(totalWithdrawals);
    document.getElementById('pendingCount').textContent = pendingWithdrawals;
    document.getElementById('approvedCount').textContent = approvedWithdrawals;
  } catch (error) {
    console.error('Stats error:', error);
  }
}

async function loadWithdrawals() {
  const container = document.getElementById('pendingWithdrawalsTable');
  
  try {
    const allUsers = await getDocs(collection(db, 'users'));
    let allPendingWithdrawals = [];
    
    for (const userDoc of allUsers.docs) {
      const userId = userDoc.id;
      const userData = userDoc.data();
      
      const withdrawalsSnapshot = await getDocs(collection(db, `users/${userId}/withdrawals`));
      
      withdrawalsSnapshot.forEach(withdrawalDoc => {
        const withdrawalData = withdrawalDoc.data();
        
        if (withdrawalData.status === 'pending') {
          allPendingWithdrawals.push({
            id: withdrawalDoc.id,
            userId: userId,
            username: userData.fullName || 'Unknown',
            userEmail: userData.email || '‚Äî',
            ...withdrawalData
          });
        }
      });
    }
    
    allPendingWithdrawals.sort((a, b) => {
      const timeA = a.createdAt?.toMillis?.() || 0;
      const timeB = b.createdAt?.toMillis?.() || 0;
      return timeB - timeA;
    });
    
    if (allPendingWithdrawals.length === 0) {
      container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>No pending withdrawals</p></div>';
      return;
    }
    
    let html = '<table><thead><tr><th>User</th><th>Amount</th><th>Bank Details</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
    
    allPendingWithdrawals.forEach(withdrawal => {
      const dateString = withdrawal.createdAt?.toDate?.().toLocaleString() || '‚Äî';
      
      html += `
        <tr>
          <td>
            <b>${withdrawal.username}</b><br>
            <small style="color:var(--text-light)">${withdrawal.userEmail}</small>
          </td>
          <td>
            <b style="color:var(--warning)">${formatCurrency(withdrawal.amount)}</b><br>
            <small>Fee: ${formatCurrency(withdrawal.fee || 0)}</small><br>
            <small style="color:var(--primary)">Net: ${formatCurrency(withdrawal.amountAfterFee || 0)}</small>
          </td>
          <td>
            <div class="bank-details">
              <div><strong>Bank:</strong> ${withdrawal.bankName || '‚Äî'}</div>
              <div><strong>Account Name:</strong> ${withdrawal.accountName || '‚Äî'}</div>
              <div><strong>Account Number:</strong> ${withdrawal.accountNumber || '‚Äî'}</div>
            </div>
          </td>
          <td>${dateString}</td>
          <td>
            <button class="btn btn-success" onclick="approveWithdrawal('${withdrawal.id}', '${withdrawal.userId}', ${withdrawal.amount}, ${withdrawal.amountAfterFee || 0}, '${(withdrawal.bankName || '').replace(/'/g, "\\'")}', '${(withdrawal.accountName || '').replace(/'/g, "\\'")}', '${withdrawal.accountNumber || ''}')">
              <i class="fas fa-check"></i> Approve
            </button>
            <button class="btn btn-danger" onclick="rejectWithdrawal('${withdrawal.id}', '${withdrawal.userId}', ${withdrawal.amount})">
              <i class="fas fa-times"></i> Reject
            </button>
          </td>
        </tr>
      `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) {
    console.error('Withdrawals error:', error);
    container.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error loading withdrawals</p><p style="font-size:0.9rem;margin-top:0.5rem;color:#ef4444">${error.message}</p></div>`;
  }
}

async function loadUsers() {
  const container = document.getElementById('usersTable');
  
  try {
    const usersQuery = query(collection(db, 'users'), orderBy('createdAt', 'desc'));
    const usersSnapshot = await getDocs(usersQuery);
    users = [];
    
    let html = '<table><thead><tr><th>Name / Username</th><th>Email</th><th>Wallet</th><th>Actions</th></tr></thead><tbody>';
    
    usersSnapshot.forEach(userDoc => {
      const user = userDoc.data();
      user.id = userDoc.id;
      users.push(user);
      
      html += `
        <tr data-uid="${userDoc.id}" data-username="${(user.username || '').toLowerCase()}" data-email="${(user.email || '').toLowerCase()}" data-name="${(user.fullName || '').toLowerCase()}">
          <td>
            <b>${user.fullName || '‚Äî'}</b><br>
            <small style="color:var(--text-light)">@${user.username || 'no-username'}</small>
          </td>
          <td>${user.email || '‚Äî'}</td>
          <td><b style="color:var(--primary)">${formatCurrency(user.wallet || 0)}</b></td>
          <td>
            <button class="btn btn-info" onclick="viewUser('${userDoc.id}')">
              <i class="fas fa-eye"></i> View
            </button>
            <button class="btn btn-info" onclick="viewReferrals('${userDoc.id}')">
              <i class="fas fa-users"></i> Refs
            </button>
            <button class="btn btn-success" onclick="fundUser('${userDoc.id}')">
              <i class="fas fa-plus"></i> Fund
            </button>
            <button class="btn btn-warning" onclick="deductFromUser('${userDoc.id}')">
              <i class="fas fa-minus"></i> Deduct
            </button>
            <button class="btn btn-danger" onclick="deleteUser('${userDoc.id}')">
              <i class="fas fa-trash"></i> Delete
            </button>
          </td>
        </tr>
      `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
    
    document.getElementById('userSearch').oninput = (e) => {
      const searchTerm = e.target.value.toLowerCase();
      document.querySelectorAll('[data-uid]').forEach(row => {
        const name = row.dataset.name || '';
        const email = row.dataset.email || '';
        const username = row.dataset.username || '';
        const match = name.includes(searchTerm) || email.includes(searchTerm) || username.includes(searchTerm);
        row.style.display = match ? '' : 'none';
      });
    };
  } catch (error) {
    console.error('Users error:', error);
    container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error loading users</p></div>';
  }
}

window.approveWithdrawal = async (withdrawalId, userId, amount, netAmount, bank, accountName, accountNumber) => {
  const result = await Swal.fire({
    title: 'üí∏ Approve Withdrawal?',
    html: `
      <div style="text-align:left;line-height:2;padding:1rem">
        <p style="margin-bottom:1rem;font-size:1.1rem;color:#38bdf8;font-weight:700">Withdrawal Details:</p>
        <div style="background:rgba(56,189,248,0.1);padding:1rem;border-radius:8px;border-left:3px solid #38bdf8;margin-bottom:1rem">
          <p><strong>Bank:</strong> ${bank}</p>
          <p><strong>Account Name:</strong> ${accountName}</p>
          <p><strong>Account Number:</strong> ${accountNumber}</p>
        </div>
        <p><strong>Original Amount:</strong> ${formatCurrency(amount)}</p>
        <p><strong>User Will Receive:</strong> <span style="color:#22c55e;font-weight:700">${formatCurrency(netAmount)}</span></p>
        <p style="color:#94a3b8;font-size:.9rem;margin-top:1rem">‚ö†Ô∏è Funds were already deducted when user made request</p>
      </div>
    `,
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: '‚úÖ Approve & Process',
    cancelButtonText: 'Cancel',
    confirmButtonColor: '#22c55e',
    width: 600
  });
  
  if (!result.isConfirmed) return;
  
  try {
    Swal.fire({
      title: 'Processing Withdrawal...',
      html: '<p>Updating records...</p>',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });
    
    await updateDoc(doc(db, `users/${userId}/withdrawals`, withdrawalId), {
      status: 'approved',
      processedAt: serverTimestamp()
    });
    
    await Swal.fire({
      title: '‚úÖ Withdrawal Approved!',
      html: `
        <p>The withdrawal has been approved successfully</p>
        <p style="margin-top:1rem;color:#94a3b8">
          Please process the payment to:<br>
          <b>${accountName}</b><br>
          ${accountNumber} (${bank})
        </p>
      `,
      icon: 'success',
      confirmButtonColor: '#22c55e'
    });
    
    loadDashboard();
  } catch (error) {
    console.error('Approve error:', error);
    Swal.fire('Error', 'Failed to approve withdrawal: ' + error.message, 'error');
  }
};

window.rejectWithdrawal = async (withdrawalId, userId, amount) => {
  const result = await Swal.fire({
    title: '‚ùå Reject Withdrawal?',
    html: `
      <div style="text-align:left;padding:1rem">
        <p>User will be <b style="color:#22c55e">refunded ${formatCurrency(amount)}</b></p>
        <p style="color:#94a3b8;font-size:.9rem;margin-top:.5rem">The full amount will be returned to their wallet</p>
        <p style="color:#eab308;margin-top:1rem">‚ö†Ô∏è Please provide a reason for rejection:</p>
      </div>
    `,
    icon: 'warning',
    input: 'textarea',
    inputPlaceholder: 'Reason for rejection (optional)',
    showCancelButton: true,
    confirmButtonText: 'Reject & Refund',
    cancelButtonText: 'Cancel',
    confirmButtonColor: '#ef4444'
  });
  
  if (!result.isConfirmed) return;
  
  try {
    Swal.fire({
      title: 'Processing Rejection...',
      html: '<p>Refunding user...</p>',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });
    
    await updateDoc(doc(db, `users/${userId}/withdrawals`, withdrawalId), {
      status: 'rejected',
      processedAt: serverTimestamp(),
      rejectionReason: result.value || 'No reason provided'
    });
    
    await updateDoc(doc(db, 'users', userId), {
      wallet: increment(amount)
    });
    
    await Swal.fire({
      title: '‚úÖ Rejected & Refunded',
      html: `<p>Withdrawal has been rejected and <b style="color:#22c55e">${formatCurrency(amount)}</b> has been refunded to user's wallet</p>`,
      icon: 'info',
      confirmButtonColor: '#38bdf8'
    });
    
    loadDashboard();
  } catch (error) {
    console.error('Reject error:', error);
    Swal.fire('Error', 'Failed to reject withdrawal: ' + error.message, 'error');
  }
};

window.viewUser = async (userId) => {
  try {
    const userDoc = await getDoc(doc(db, 'users', userId));
    if (!userDoc.exists()) return;
    
    const user = userDoc.data();
    const refsSnapshot = await getDocs(collection(db, `users/${userId}/referrals`));
    const depositsSnapshot = await getDocs(collection(db, `users/${userId}/deposits`));
    const withdrawalsSnapshot = await getDocs(collection(db, `users/${userId}/withdrawals`));
    const plansSnapshot = await getDocs(collection(db, `users/${userId}/activePlans`));
    
    Swal.fire({
      title: user.fullName || 'User Details',
      html: `
        <div style="text-align:left;line-height:2.2;padding:1rem">
          <p><b>üë§ Full Name:</b> ${user.fullName || '‚Äî'}</p>
          <p><b>üîñ Username:</b> <span style="color:#38bdf8">@${user.username || 'no-username'}</span></p>
          <p><b>üìß Email:</b> ${user.email || '‚Äî'}</p>
          <p><b>üí∞ Wallet:</b> <span style="color:#22c55e;font-weight:700">${formatCurrency(user.wallet || 0)}</span></p>
          <p><b>üë§ Role:</b> ${user.role || 'user'}</p>
          <p><b>üìä Status:</b> ${user.status || 'active'}</p>
          <p><b>üë• Referrals:</b> ${refsSnapshot.size}</p>
          <p><b>üì• Deposits:</b> ${depositsSnapshot.size}</p>
          <p><b>üì§ Withdrawals:</b> ${withdrawalsSnapshot.size}</p>
          <p><b>üìä Active Plans:</b> ${plansSnapshot.size}</p>
          <p><b>üìÖ Joined:</b> ${user.createdAt?.toDate?.().toLocaleDateString() || '‚Äî'}</p>
        </div>
      `,
      width: 600,
      confirmButtonColor: '#22c55e'
    });
  } catch (error) {
    console.error('View user error:', error);
    Swal.fire('Error', error.message, 'error');
  }
};

window.viewReferrals = async (userId) => {
  try {
    const userDoc = await getDoc(doc(db, 'users', userId));
    if (!userDoc.exists()) {
      Swal.fire('Error', 'User not found', 'error');
      return;
    }
    
    const user = userDoc.data();
    const refsSnapshot = await getDocs(collection(db, `users/${userId}/referrals`));
    
    if (refsSnapshot.empty) {
      Swal.fire({
        title: `${user.fullName}'s Referrals`,
        html: '<div class="empty-state"><i class="fas fa-users"></i><p>No referrals yet</p></div>',
        width: 900,
        confirmButtonColor: '#22c55e'
      });
      return;
    }
    
    // Group referrals by level
    let level1Refs = [];
    let level2Refs = [];
    let level3Refs = [];
    
    for (const refDoc of refsSnapshot.docs) {
      const refData = refDoc.data();
      const level = refData.level || 1;
      
      try {
        const refUserDoc = await getDoc(doc(db, 'users', refData.referredUserId));
        
        if (refUserDoc.exists()) {
          const refUserData = refUserDoc.data();
          
          // Calculate total investments by this referral
          let totalInvested = 0;
          try {
            const plansSnapshot = await getDocs(collection(db, `users/${refData.referredUserId}/activePlans`));
            plansSnapshot.forEach(planDoc => {
              const planData = planDoc.data();
              totalInvested += planData.capital || 0;
            });
          } catch (e) {
            console.error('Error calculating investments:', e);
          }
          
          const refInfo = {
            name: refUserData.fullName || refData.referredUserName || '‚Äî',
            username: refUserData.username || refData.referredUsername || '‚Äî',
            email: refUserData.email || refData.referredUserEmail || '‚Äî',
            joinedDate: refData.referredAt?.toDate?.().toLocaleDateString() || '‚Äî',
            commission: refData.commission || 0,
            totalEarned: refData.totalEarned || 0,
            totalInvested: totalInvested
          };
          
          if (level === 1) level1Refs.push(refInfo);
          else if (level === 2) level2Refs.push(refInfo);
          else if (level === 3) level3Refs.push(refInfo);
        }
      } catch (error) {
        console.error('Error fetching referral user:', error);
      }
    }
    
    let html = '<div style="text-align:left;max-height:500px;overflow-y:auto;padding:.5rem">';
    
    // Display Level 1 Referrals
    if (level1Refs.length > 0) {
      html += `
        <h3 style="color:#22c55e;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem">
          <i class="fas fa-user-friends"></i> Direct Referrals (Level 1) - ${level1Refs.length}
          <span class="referral-level level-1">${level1Refs[0].commission}% Commission</span>
        </h3>
        <table style="width:100%;border-collapse:collapse;margin-bottom:2rem">
          <thead>
            <tr style="background:#1e293b;position:sticky;top:0">
              <th style="padding:0.8rem;text-align:left;border-bottom:2px solid #334155">Name / Username</th>
              <th style="padding:0.8rem;text-align:left;border-bottom:2px solid #334155">Email</th>
              <th style="padding:0.8rem;text-align:left;border-bottom:2px solid #334155">Joined</th>
              <th style="padding:0.8rem;text-align:left;border-bottom:2px solid #334155">Earned</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      level1Refs.forEach(ref => {
        html += `
          <tr style="border-bottom:1px solid #334155">
            <td style="padding:0.8rem">
              <b>${ref.name}</b><br>
              <small style="color:#94a3b8">@${ref.username}</small>
            </td>
            <td style="padding:0.8rem;color:#94a3b8">${ref.email}</td>
            <td style="padding:0.8rem;color:#94a3b8">${ref.joinedDate}</td>
            <td style="padding:0.8rem;color:#22c55e;font-weight:600">${formatCurrency(ref.totalEarned)}</td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
    }
    
    // Display Level 2 Referrals
    if (level2Refs.length > 0) {
      html += `
        <h3 style="color:#38bdf8;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem">
          <i class="fas fa-users"></i> Level 2 Referrals - ${level2Refs.length}
          <span class="referral-level level-2">${level2Refs[0].commission}% Commission</span>
        </h3>
        <table style="width:100%;border-collapse:collapse;margin-bottom:2rem">
          <thead>
            <tr style="background:#1e293b;position:sticky;top:0">
              <th style="padding:0.8rem;text-align:left;border-bottom:2px solid #334155">Name / Username</th>
              <th style="padding:0.8rem;text-align:left;border-bottom:2px solid #334155">Email</th>
              <th style="padding:0.8rem;text-align:left;border-bottom:2px solid #334155">Joined</th>
              <th style="padding:0.8rem;text-align:left;border-bottom:2px solid #334155">Earned</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      level2Refs.forEach(ref => {
        html += `
          <tr style="border-bottom:1px solid #334155">
            <td style="padding:0.8rem">
              <b>${ref.name}</b><br>
              <small style="color:#94a3b8">@${ref.username}</small>
            </td>
            <td style="padding:0.8rem;color:#94a3b8">${ref.email}</td>
            <td style="padding:0.8rem;color:#94a3b8">${ref.joinedDate}</td>
            <td style="padding:0.8rem;color:#22c55e;font-weight:600">${formatCurrency(ref.totalEarned)}</td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
    }
    
    // Display Level 3 Referrals
    if (level3Refs.length > 0) {
      html += `
        <h3 style="color:#eab308;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem">
          <i class="fas fa-network-wired"></i> Level 3 Referrals - ${level3Refs.length}
          <span class="referral-level level-3">${level3Refs[0].commission}% Commission</span>
        </h3>
        <table style="width:100%;border-collapse:collapse">
          <thead>
            <tr style="background:#1e293b;position:sticky;top:0">
              <th style="padding:0.8rem;text-align:left;border-bottom:2px solid #334155">Name / Username</th>
              <th style="padding:0.8rem;text-align:left;border-bottom:2px solid #334155">Email</th>
              <th style="padding:0.8rem;text-align:left;border-bottom:2px solid #334155">Joined</th>
              <th style="padding:0.8rem;text-align:left;border-bottom:2px solid #334155">Earned</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      level3Refs.forEach(ref => {
        html += `
          <tr style="border-bottom:1px solid #334155">
            <td style="padding:0.8rem">
              <b>${ref.name}</b><br>
              <small style="color:#94a3b8">@${ref.username}</small>
            </td>
            <td style="padding:0.8rem;color:#94a3b8">${ref.email}</td>
            <td style="padding:0.8rem;color:#94a3b8">${ref.joinedDate}</td>
            <td style="padding:0.8rem;color:#22c55e;font-weight:600">${formatCurrency(ref.totalEarned)}</td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
    }
    
    html += '</div>';
    
    const totalRefs = level1Refs.length + level2Refs.length + level3Refs.length;
    const totalEarned = [...level1Refs, ...level2Refs, ...level3Refs].reduce((sum, ref) => sum + ref.totalEarned, 0);
    
    Swal.fire({
      title: `${user.fullName}'s Referral Network`,
      html: `
        <div style="text-align:center;padding:1rem;background:rgba(34,197,94,0.1);border-radius:8px;margin-bottom:1rem">
          <p style="font-size:0.9rem;color:#94a3b8">Total Network Size: <b style="color:#22c55e;font-size:1.2rem">${totalRefs}</b></p>
          <p style="font-size:0.9rem;color:#94a3b8;margin-top:0.5rem">Total Earnings: <b style="color:#22c55e;font-size:1.2rem">${formatCurrency(totalEarned)}</b></p>
        </div>
        ${html}
      `,
      width: 1000,
      confirmButtonColor: '#22c55e'
    });
  } catch (error) {
    console.error('View referrals error:', error);
    Swal.fire('Error', error.message, 'error');
  }
};

window.fundUser = async (userId) => {
  const { value: amount } = await Swal.fire({
    title: 'üí∞ Fund User Wallet',
    html: '<p style="margin-bottom:1rem;color:#94a3b8">Add funds to user\'s wallet</p>',
    input: 'number',
    inputLabel: 'Amount (‚Ç¶)',
    inputPlaceholder: 'Enter amount to add',
    inputAttributes: {
      min: 1,
      step: 1
    },
    showCancelButton: true,
    confirmButtonText: 'Add Funds',
    confirmButtonColor: '#22c55e',
    inputValidator: (value) => {
      if (!value || value <= 0) {
        return 'Please enter a valid amount';
      }
    }
  });
  
  if (!amount) return;
  
  const confirm = await Swal.fire({
    title: 'Confirm Fund Addition',
    html: `<p>Add <b style="color:#22c55e">${formatCurrency(amount)}</b> to user's wallet?</p>`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'Yes, Add Funds',
    confirmButtonColor: '#22c55e'
  });
  
  if (!confirm.isConfirmed) return;
  
  try {
    Swal.fire({
      title: 'Adding Funds...',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });
    
    await updateDoc(doc(db, 'users', userId), {
      wallet: increment(Number(amount))
    });
    
    await Swal.fire({
      title: '‚úÖ Success!',
      html: `<p><b style="color:#22c55e">${formatCurrency(amount)}</b> has been added to the user's wallet</p>`,
      icon: 'success',
      confirmButtonColor: '#22c55e'
    });
    
    loadDashboard();
  } catch (error) {
    console.error('Fund error:', error);
    Swal.fire('Error', 'Failed to add funds: ' + error.message, 'error');
  }
};

window.deductFromUser = async (userId) => {
  try {
    const userDoc = await getDoc(doc(db, 'users', userId));
    if (!userDoc.exists()) {
      Swal.fire('Error', 'User not found', 'error');
      return;
    }
    
    const balance = userDoc.data().wallet || 0;
    
    const { value: amount } = await Swal.fire({
      title: '‚ûñ Deduct from Wallet',
      html: `<p style="margin-bottom:1rem">Current Balance: <b style="color:#22c55e">${formatCurrency(balance)}</b></p>`,
      input: 'number',
      inputLabel: 'Amount to Deduct (‚Ç¶)',
      inputPlaceholder: 'Enter amount',
      inputAttributes: {
        min: 1,
        max: balance,
        step: 1
      },
      showCancelButton: true,
      confirmButtonText: 'Deduct Amount',
      confirmButtonColor: '#eab308',
      inputValidator: (value) => {
        if (!value || value <= 0) {
          return 'Invalid amount';
        }
        if (value > balance) {
          return 'Amount exceeds current balance';
        }
      }
    });
    
    if (!amount) return;
    
    const confirm = await Swal.fire({
      title: 'Confirm Deduction',
      html: `
        <p>Deduct <b style="color:#eab308">${formatCurrency(amount)}</b> from user's wallet?</p>
        <p style="margin-top:0.5rem;color:#94a3b8">New balance will be: <b>${formatCurrency(balance - amount)}</b></p>
      `,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Yes, Deduct',
      confirmButtonColor: '#eab308'
    });
    
    if (!confirm.isConfirmed) return;
    
    Swal.fire({
      title: 'Processing...',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });
    
    await updateDoc(doc(db, 'users', userId), {
      wallet: increment(-Number(amount))
    });
    
    await Swal.fire({
      title: '‚úÖ Success!',
      html: `<p><b style="color:#eab308">${formatCurrency(amount)}</b> has been deducted from the wallet</p>`,
      icon: 'success',
      confirmButtonColor: '#22c55e'
    });
    
    loadDashboard();
  } catch (error) {
    console.error('Deduct error:', error);
    Swal.fire('Error', 'Failed to deduct funds: ' + error.message, 'error');
  }
};

window.deleteUser = async (userId) => {
  const firstConfirm = await Swal.fire({
    title: '‚ö†Ô∏è Delete User?',
    html: `
      <p style="color:#ef4444;font-weight:600">This action is PERMANENT!</p>
      <p style="margin-top:1rem;color:#94a3b8">All user data will be deleted including deposits, withdrawals, referrals, and plans.</p>
    `,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Yes, Delete User',
    cancelButtonText: 'Cancel',
    confirmButtonColor: '#ef4444'
  });
  
  if (!firstConfirm.isConfirmed) return;
  
  const finalConfirm = await Swal.fire({
    title: 'Final Confirmation',
    text: 'Are you absolutely sure? This CANNOT be undone!',
    icon: 'error',
    showCancelButton: true,
    confirmButtonText: 'Delete Permanently',
    cancelButtonText: 'Cancel',
    confirmButtonColor: '#ef4444'
  });
  
  if (!finalConfirm.isConfirmed) return;
  
  try {
    Swal.fire({
      title: 'Deleting User...',
      html: '<p>Please wait while we remove all data...</p>',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });
    
    const batch = writeBatch(db);
    batch.delete(doc(db, 'users', userId));
    
    const deposits = await getDocs(collection(db, `users/${userId}/deposits`));
    deposits.forEach(d => batch.delete(d.ref));
    
    const withdrawals = await getDocs(collection(db, `users/${userId}/withdrawals`));
    withdrawals.forEach(w => batch.delete(w.ref));
    
    const plans = await getDocs(collection(db, `users/${userId}/activePlans`));
    plans.forEach(p => batch.delete(p.ref));
    
    const refs = await getDocs(collection(db, `users/${userId}/referrals`));
    refs.forEach(r => batch.delete(r.ref));
    
    await batch.commit();
    
    await Swal.fire({
      title: '‚úÖ User Deleted',
      text: 'User and all associated data have been permanently removed',
      icon: 'success',
      confirmButtonColor: '#22c55e'
    });
    
    loadDashboard();
  } catch (error) {
    console.error('Delete error:', error);
    Swal.fire('Error', 'Failed to delete user: ' + error.message, 'error');
  }
};
</script>
</body>
</html>